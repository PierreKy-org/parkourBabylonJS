<html>
  <head>
    <title>Generateur de Niveau</title>
    <meta charset="UTF-8" />
    <link rel="stylesheet" href="css/default.css" />
  </head>
  <body id="mapCreatorBody">
    <form>
      <input type="text" id="mapInput" name="mapInput" placeholder="./assets/level1.json" />
      <input type="button" value="Import" onclick="importMap()" />
      <input type="button" value="Save" onclick="exportMap()" />
      <input type="number" id="mapWidth" name="mapWidth" min="10" max="190" placeholder="Width" />
      <input type="number" id="mapHeigth" name="mapHeigth" min="10" max="190" placeholder="Height" />
    </form>
    <div id="mapDisplay"><table id="mapTable"></table></div>
  </body>
  <script>
    async function importMap() {
      const file = await fetch(document.getElementById("mapInput").value);

      let json;
      try {
        json = await file.json();
      } catch (error) {
        let mapWidth = document.getElementById("mapWidth");
        let mapHeight = document.getElementById("mapHeigth");
        const w = mapWidth.value == "" ? 10 : parseInt(mapWidth.value, 10);
        const h = mapHeight.value == "" ? 10 : parseInt(mapHeight.value, 10);

        json = [];
        for (let i = 0; i < h; i++) {
          let line = [];
          for (let j = 0; j < w; j++) {
            line.push(0);
          }
          json.push(line);
        }
      }
      levelGenerator(json);
    }

    function exportMap() {
      let map = document.getElementById("mapTable");
      let json = [];
      for (let tr of map.childNodes) {
        let line = [];
        for (let td of tr.childNodes) {
          line.push(parseInt(td.innerHTML, 10));
        }
        json.push(line);
      }
      navigator.clipboard.writeText(JSON.stringify(json));
    }

    function levelGenerator(json) {
      let map = document.getElementById("mapTable");
      map.innerHTML = "";
      for (let i = 0; i < json.length; i++) {
        let line = document.createElement("tr");
        for (let j = 0; j < json[0].length; j++) {
          let square = document.createElement("td");
          square.innerHTML = json[i][j];
          square.classList.add(`tile_${json[i][j]}`);
          square.addEventListener("click", () => {
            square.className = "";
            square.innerHTML = (parseInt(square.innerHTML, 10) + 1) % 10;
            square.classList.add(`tile_${square.innerHTML}`);
          });
          square.addEventListener("contextmenu", (e) => {
            e.preventDefault();
            square.className = "";
            square.innerHTML = 0;
            square.classList.add(`tile_${square.innerHTML}`);
          });

          line.appendChild(square);
        }
        map.appendChild(line);
      }
    }
  </script>
</html>
